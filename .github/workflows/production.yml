# References https://docs.docker.com/build/ci/github-actions/
# https://stackoverflow.com/questions/77740410/github-docker-build-push-action-with-multiple-architectures-is-slow

name: 'Production Environment CI/CD Pipeline'

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [20, 22]
    name: Run Tests on ${{ matrix.os }} with Node ${{ matrix.node }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Setup Node ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install Frontend Node Dependencies
        working-directory: peer-prep
        run: npm ci

      - name: Test Build on Frontend
        working-directory: peer-prep
        run: npm run build

      - name: Test User Service
        working-directory: user-sevice
        run: |
          npm ci
          npm run test

      - name: Test Question Service
        working-directory: question-sevice
        run: |
          npm ci
          npm run test

      - name: Test Matching Service
        working-directory: matching-sevice
        run: |
          npm ci
          npm run test

      - name: Test Collaboration Service
        working-directory: collaboration-sevice
        run: |
          npm ci
          npm run test

      - name: Test Communication Service
        working-directory: communication-sevice
        run: |
          npm ci
          npm run test

      - name: Test Run Service
        working-directory: run-sevice
        run: |
          npm ci
          npm run test

  build:
    # build container for both x86 and arm platforms
    needs: test
    name: Build Production Containers and Push to Docker Hub
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [amd64, arm64]
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Image
        uses: docker/build-push-action@v6
        with:
          context: ./peer-prep
          file: ./peer-prep/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-frontend:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-frontend:${{ github.sha }}

      - name: Build User Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./user-service
          file: ./user-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-user-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-user-service:${{ github.sha }}

      - name: Build Question Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./run-service
          file: ./run-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-question-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-question-service:${{ github.sha }}

      - name: Build Matching Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./matching-service
          file: ./matching-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-matching-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-matching-service:${{ github.sha }}

      - name: Build Collaboration Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./collaboration-service
          file: ./collaboration-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-collaboration-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-collaboration-service:${{ github.sha }}

      - name: Build Communication Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./communication-service
          file: ./communication-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-communication-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-communication-service:${{ github.sha }}

      - name: Build Run Service Image
        uses: docker/build-push-action@v6
        with:
          context: ./run-service
          file: ./run-service/Dockerfile
          push: true
          platforms: linux/${{ matrix.arch }}
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-run-service:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/peerprep-run-service:${{ github.sha }}

  deploy:
    needs: build
    environment: staging
    name: Deploy Production Environment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Codebase
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: 20
